## 1.9 - Migrate a Virtue

### Test Description

Using the Admin CLI, migrate a given user's virtue. Can we also migrate all virtues on a given valor?

### Preconditions

Cloud Formation script has run to completion.

### Steps to Test

- Connect to the Excalibur instance
    - Add key `starlab-virtue-te` to your SSH agent
    - Find the public IP for the `Virtue-XX-Excalibur` instance (where `XX` is your stack suffix) 
    - SSH to the Excalibur instance using PuTTY or a command-line SSH connection as the `ubuntu` user using the above SSH key
- On the Excalibur instance, obtain an auth token for the admin CLI:

        cd /home/ubuntu/galahad/excalibur/cli
        
        python3 sso_login.py -u jmitchell@virtue.com -o token.json -p Test123! -A APP_1 excalibur.galahad.com:5002
        # This will prompt for a password: Test123!
        
        export VIRTUE_ADDRESS=excalibur.galahad.com
        export VIRTUE_TOKEN=`cat token.json`

- Follow test 1.01 (deploy valors) to create at least 2 new valors.
- Follow test 1.02 (list roles) to confirm the firefox123 role exists. If the role does not exist follow test 1.04 to create the new role.
- Follow test 1.03 (list users) to confirm there is at least one user. If there is not follow test 1.05 to add a new user.
- Use the admin CLI to authorize a user for the firefox123 role:

        ./virtue-admin user role authorize --username=<username> --roleId=<firefox123 role id>

- Use the admin CLI to create a new virtue:

        ./virtue-admin virtue create --username=<username> --roleId=<firefox123 role id>

- Use the admin CLI to list the virtues and wait for the state to transition from CREATING to STOPPED:

        ./virtue-admin user virtue list --username=<username>

- Use the admin CLI to launch the just created virtue:

        ./virtue virtue launch --virtueId=<virtue id>

- Use the admin CLI to list the virtues and confirm the state is RUNNING:

        ./virtue-admin user virtue list --username=<username>

- Use the BFT to determine which valor the newly created virtue is running on.

- Use the admin CLI to migrate the virtue to the other valor:

        ./virtue-admin valor migrate virtue --virtue_id=<virtue id> --destination_valor_id=<valor id>

### Expected Result

After confirming a user and the firefox123 role exist. The API call to add the user role authorization should return the following:

```json
{
    "result": [
        0,
        "Successfully completed operation."
    ],
    "status": "success"
}

```
The creation of the new virtue should have a response of the following form:

```json
{
    "id": "Virtue_wincmd456_1548191058",
    "ipAddress": "NULL"
}

```
While creating the virtue (which takes a while, 10 - 20 seconds) the virtue list should return something of the following form:

```json
[
    {
        "applicationIds": [],
        "id": "Virtue_firefox123_1548188921",
        "ipAddress": "10.91.0.3",
        "resourceIds": [],
        "roleId": "firefox1231548186134",
        "state": "RUNNING",
        "transducerIds": [],
        "username": "jmitchell"
    },
    {
        "applicationIds": [],
        "id": "Virtue_wincmd456_1548191058",
        "ipAddress": "NULL",
        "resourceIds": [],
        "roleId": "wincmd4561548186263",
        "state": "CREATING",
        "transducerIds": [],
        "username": "jmitchell"
    }
]

```

After the virtue is created, the state will become STOPPED.

Successful migration returns the following:

```json
{
    "valor_id": null
}

```

### Actual Result

5af6d43454445ffa2fa44b081ad6fecb80c4d23a

*Tested: 1/22/2019 by Tom McGinley*

List of valors:

```json
ubuntu@ip-172-30-1-44:~/galahad/excalibur/cli$ ./virtue-admin valor list
[
    {
        "address": "172.30.25.85",
        "function": "valor",
        "guestnet": "10.91.0.1",
        "id": "fc19d44f-6d6e-4a73-9c68-baacfad73bc5",
        "valor_id": "i-02cd3f7d4050bac56"
    },
    {
        "address": "172.30.20.236",
        "function": "valor",
        "guestnet": "10.91.0.2",
        "id": "cf9ec213-da6b-49c2-9f4f-b73cc121d438",
        "valor_id": "i-0c8ec85700d310ba7"
    }
]

```

Role authorization:

```json
ubuntu@ip-172-30-1-44:~/galahad/excalibur/cli$ ./virtue-admin user role authorize --username=jmitchell --roleId=firefox1231548186134
{
    "result": [
        0,
        "Successfully completed operation."
    ],
    "status": "success"
}
```

Virtue create:

```json
ubuntu@ip-172-30-1-44:~/galahad/excalibur/cli$ ./virtue-admin virtue create --username=jmitchell --roleId=firefox1231548186134
{
    "id": "Virtue_firefox123_1548188921",
    "ipAddress": "NULL"
}

```

Virtue list after state transitions from CREATING to STOPPED (takes about 20 seconds):

```json
ubuntu@ip-172-30-1-44:~/galahad/excalibur/cli$ ./virtue-admin user virtue list --username=jmitchell
[
    {
        "applicationIds": [],
        "id": "Virtue_firefox123_1548188921",
        "ipAddress": "NULL",
        "resourceIds": [],
        "roleId": "firefox1231548186134",
        "state": "STOPPED",
        "transducerIds": [],
        "username": "jmitchell"
    }
]
```

Virtue launch:

```json
ubuntu@ip-172-30-1-44:~/galahad/excalibur/cli$ ./virtue virtue launch --virtueId=Virtue_firefox123_1548188921
{
    "result": [
        0,
        "Successfully completed operation."
    ],
    "status": "success"
}

```
Virtue list after successful launch (state is RUNNING):

```json
ubuntu@ip-172-30-1-44:~/galahad/excalibur/cli$ ./virtue-admin user virtue list --username=jmitchell[
    {
        "applicationIds": [],
        "id": "Virtue_firefox123_1548188921",
        "ipAddress": "10.91.0.3",
        "resourceIds": [],
        "roleId": "firefox1231548186134",
        "state": "RUNNING",
        "transducerIds": [],
        "username": "jmitchell"
    }
]

```

BFT indicates the virtue is running on the valor with ID i-02cd3f7d4050bac56, so we will migrate to the other valor.
```json
ubuntu@ip-172-30-1-44:~/galahad/excalibur/cli$ ./virtue-admin valor migrate virtue --virtue_id=Virtue_firefox123_1548188921 --destination_valor_id=i-0c8ec85700d310ba7
{
    "valor_id": null
}

```

After about 10 seconds the BFT updates showing the virtue running on the other valor. We have to use BFT to determine which valor a virtue is running on because there is no way to get that information from the API.

NOTE: Migrating more than 1 virtue is TBD since multiple virtues on a valor is not currently supported.
