## 1.8 - Stop a Virtue

### Test Description

Using the Admin CLI, stop a given userâ€™s virtue.

### Preconditions

Cloud Formation script has run to completion.

### Steps to Test

- Connect to the Excalibur instance
    - Add key `starlab-virtue-te` to your SSH agent
    - Find the public IP for the `Virtue-XX-Excalibur` instance (where `XX` is your stack suffix) 
    - SSH to the Excalibur instance using PuTTY or a command-line SSH connection as the `ubuntu` user using the above SSH key
- On the Excalibur instance, obtain an auth token for the admin CLI:

        cd /home/ubuntu/galahad/excalibur/cli
        
        python3 sso_login.py -u jmitchell@virtue.com -o token.json -p Test123! -A APP_1 excalibur.galahad.com:5002
        # This will prompt for a password: Test123!
        
        export VIRTUE_ADDRESS=excalibur.galahad.com
        export VIRTUE_TOKEN=`cat token.json`
- Use the admin CLI to list the users currently in the system:

        cd /home/ubuntu/galahad/excalibur/cli
        ./virtue-admin user list

- Use the admin CLI to list virtue instances for a user:

        ./virtue-admin user virtue list --username=<username>
       
- Use the user API to stop a running virtue:

        ./virtue virtue stop --virtueId=<virtueId>

- Use the user API to verify the virtue state is STOPPED:

        ./virtue virtue get --virtueId=<virtueId>

- Use the user API to re-launch the stopped virtue:

        ./virtue virtue launch --virtueId=<virtueId>


### Expected Result

For each user, you should see an entry like this:

```json
{
    "authorizedRoleIds": [ "role_id_1", ..., "role_id_n"],
    "username": "some.username"
}
```

When listing virtue instances for one of the users there should be a list of the form:

```json
[
    {
        "applicationIds": [],
        "id": "Virtue_firefox123_1546984484",
        "ipAddress": "10.91.0.2",
        "resourceIds": [],
        "roleId": "firefox1231546885862",
        "state": "RUNNING",
        "transducerIds": [],
        "username": "jmitchell"
    }
]

```
After stopping the virtue, you should see an entry like this:

```json
{
    "result": [
        0,
        "Successfully completed operation."
    ],
    "status": "success"
}

```
Getting the virtue details should show its state as STOPPED:

```json
{
    "applicationIds": [],
    "id": "Virtue_firefox123_1546984484",
    "ipAddress": "10.91.0.2",
    "resourceIds": [],
    "roleId": "firefox1231546885862",
    "state": "STOPPED",
    "transducerIds": [],
    "username": "jmitchell"
}

```
After re-launching the virtue, you should see an entry like this (Takes several seconds):

```json
{
    "result": [
        0,
        "Successfully completed operation."
    ],
    "status": "success"
}

```
### Actual Result
8f49db13a7e64608bbfc677f8e0ffd21b092865d

*Tested: 1/15/2019 by Tom McGinley*

List of users:

```json
[
    {
        "authorizedRoleIds": [
            "firefox1231546885862"
        ],
        "username": "jmitchell"
    },
    {
        "authorizedRoleIds": [],
        "username": "fpatwa"
    },
    {
        "authorizedRoleIds": [],
        "username": "klittle"
    }
]

```

List of virtues for username=jmitchell:

```json
[
    {
        "applicationIds": [],
        "id": "Virtue_firefox123_1546984484",
        "ipAddress": "10.91.0.2",
        "resourceIds": [],
        "roleId": "firefox1231546885862",
        "state": "RUNNING",
        "transducerIds": [],
        "username": "jmitchell"
    }
]
```

Response to request to stop --virtueId=Virtue_firefox123_1546984484:

```json
{
    "result": [
        0,
        "Successfully completed operation."
    ],
    "status": "success"
}

```

Response to get info on --virtueId=Virtue_firefox123_1546984484, showing its state is STOPPED:

```json
{
    "applicationIds": [],
    "id": "Virtue_firefox123_1546984484",
    "ipAddress": "10.91.0.2",
    "resourceIds": [],
    "roleId": "firefox1231546885862",
    "state": "STOPPED",
    "transducerIds": [],
    "username": "jmitchell"
}

```

Response to request to re-launch --virtueId=Virtue_firefox123_1546984484:

```json
{
    "result": [
        0,
        "Successfully completed operation."
    ],
    "status": "success"
}

```
Response to get info on --virtueId=Virtue_firefox123_1546984484, showing its state is RUNNING again:

```json
{
    "applicationIds": [],
    "id": "Virtue_firefox123_1546984484",
    "ipAddress": "10.91.0.2",
    "resourceIds": [],
    "roleId": "firefox1231546885862",
    "state": "RUNNING",
    "transducerIds": [],
    "username": "jmitchell"
}

```

#### 5af6d43454445ffa2fa44b081ad6fecb80c4d23a

*Tested 1/23/2019 by Tom McGinley*

Test passed as before.

