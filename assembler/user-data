#cloud-config
password: password
chpasswd: { expire: False }
ssh_pwauth: True
repo_update: true

packages:
  - curl
  - apt-transport-https
  - ca-certificates
  - software-properties-common

runcmd:
  - /usr/local/sbin/install_setup_docker.sh
  - [ sh, -c, apt-get autoremove -y ]
  - [ sh, -c, apt-get autoclean -y ]
  - [ sh, -xc, "echo $(date) ' : hello '" ]
  - [ sh, -c, echo "======== Ended =========" ]

output:
  all: '| tee -a /var/log/cloud-init-output.log'

groups:
  - docker

users:
  - default
  - name: virtue
    groups: [sudo, docker]
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD:ALL']
    lock_passwd: false
    passwd: "$6$rounds=4096$XfVIlcpYi$RBDjsNNWI0zHbN78zLfFQ80rB14w68fmBuSpngbheVT8khaQqQueIMfK0Rr15..L1YuawNYH34u1jLOG6nmCu1"

write_files:
  - path: /usr/local/sbin/install_setup_docker.sh
    permissions: '0755'
    content: |
        #!/bin/bash

        # immediately exit on failure
        set -e

        # prevent apt-get from throwing interactive errors
        export DEBIAN_FRONTEND=noninteractive

        command_exists() {
          command -v "$@" > /dev/null 2>&1
        }

        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
        sudo add-apt-repository \
          "deb [arch=amd64] https://download.docker.com/linux/ubuntu \
          $(lsb_release -cs) \
          stable test"
        sudo apt-get update
        sudo apt-get install docker-ce -y

        # make sure docker is installed
        if ! command_exists docker; then
          echo "Error: failed to find docker after running through installation"
          exit 1
        else
          (
            set -x
            sh -c "docker version"
          ) || true
        fi

        # Enable docker if not enabled
        if ! systemctl -q is-enabled docker; then
          echo "Warning: docker service was not enabled, attempting to enable it"
          sudo systemctl enable docker
        fi

        # Start docker if not up
        if ! systemctl -q is-active docker; then
          echo "Warning: docker service was not started, attempting to start it"
          sudo systemctl start docker
        fi
        exit 0
